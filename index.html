<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ceremony Slides</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        border: 0;
      }
      html,
      body {
        height: 100%;
        width: 100%;
        overflow: hidden;
        background-color: black; /* Ensures clean background */
      }
      #imageContainer {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100vw;
        height: 100vh;
        background-color: black;
      }
      img {
        max-width: 100%;
        max-height: 100vh;
        height: auto;
        object-fit: contain;
      }
      #loadingMessage {
        color: white;
        font-size: 16px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="imageContainer">
      <div id="loadingMessage">Loading...</div>
    </div>

    <script>
      // Initialize Supabase client
      const supabaseUrl = "https://mkvmvpjkpcgqicycjrlp.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1rdm12cGprcGNncWljeWNqcmxwIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0NjU3NzY5NCwiZXhwIjoyMDYyMTUzNjk0fQ.HtHzuuld0FGvaKLO5eycMi8MCXSBelmKPZCLWZpavng";
      const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

      // Variable to track the current slide number
      let currentSlideNumber = null;
      const imageContainer = document.getElementById("imageContainer");

      // Function to get all image files from ceremony folder
      let ceremonyImages = [];

      // Function to preload images
      async function preloadImages() {
        // In a real GitHub Pages environment, we would need to know the names
        // of the images in advance or use a server component
        // For now, we'll load them on demand
      }

      // Function to fetch slide data
      async function fetchSlideData() {
        try {
          const { data, error } = await supabase
            .from("slide")
            .select("*")
            .limit(1)
            .single();

          if (error) throw error;

          // Only update if slide number has changed
          const newSlideNumber = data.slide_number || 0;
          if (currentSlideNumber !== newSlideNumber) {
            console.log(
              `Slide updated: ${newSlideNumber} (was: ${
                currentSlideNumber === null
                  ? "initial load"
                  : currentSlideNumber
              })`
            );
            currentSlideNumber = newSlideNumber;
            updateSlide(newSlideNumber);
          }
        } catch (error) {
          console.error("Error fetching slide data:", error);
          imageContainer.innerHTML =
            '<div id="loadingMessage">Error loading slide data</div>';
        }
      }

      // Function to update the slide
      function updateSlide(slideNumber) {
        // Clear the container
        imageContainer.innerHTML =
          '<div id="loadingMessage">Loading slide ' + slideNumber + "...</div>";

        // Get image name based on slideNumber
        let imageName;
        switch (slideNumber) {
          case 0:
          case 1:
            imageName = "1. Before we start.png";
            break;
          case 2:
            imageName = "2. Ganesh Puja.png";
            break;
          case 3:
            imageName = "3. Jilakara Bellam.png";
            break;
          case 4:
            imageName = "4. Kanyadaanam.png";
            break;
          case 5:
            imageName = "5. Mangalya Dharanam.png";
            break;
          case 6:
            imageName = "6. Talambralu.png";
            break;
          case 7:
            imageName = "7. Mala Dharanam.png";
            break;
          case 8:
            imageName = "8. Laaja Homam.png";
            break;
          case 9:
            imageName = "9. Saptapadi.png";
            break;
          case 10:
            imageName = "10. Arundhati Darshanam & Arati.png";
            break;
          default:
            // If slideNumber is beyond our range, cycle back or use a default
            imageName = "1. Before we start.png";
            console.log(
              `No image mapped for slide ${slideNumber}, using default`
            );
        }

        // Try different path approaches
        console.log("Current URL path:", window.location.pathname);
        console.log("Current URL:", window.location.href);

        // Try multiple paths
        const paths = [
          `ceremony/${imageName}`,
          `./ceremony/${imageName}`,
          `/ceremony/${imageName}`,
          `../ceremony/${imageName}`,
        ];

        // Try loading from each path
        tryNextPath(paths, 0);
      }

      // Try loading from multiple paths
      function tryNextPath(paths, index) {
        if (index >= paths.length) {
          // We've tried all paths
          imageContainer.innerHTML = `<div id="loadingMessage">
            Failed to load image from all paths.<br>
            Please check network connectivity or<br>
            repository configuration.
          </div>`;
          return;
        }

        const path = paths[index];
        console.log(`Trying path ${index + 1}/${paths.length}: ${path}`);

        const img = new Image();

        // Apply styles programmatically to ensure they're set
        img.style.maxWidth = "100%";
        img.style.maxHeight = "100vh";
        img.style.height = "auto";
        img.style.objectFit = "contain";

        img.src = path;

        img.onload = function () {
          // Success! Clear container and add this image
          imageContainer.innerHTML = "";
          imageContainer.appendChild(img);
          console.log(`Successfully loaded: ${path}`);
        };

        img.onerror = function () {
          // Try next path
          console.error(`Failed to load from path: ${path}`);
          tryNextPath(paths, index + 1);
        };
      }

      // Initial fetch
      fetchSlideData();

      // Refresh data every 5 seconds
      setInterval(fetchSlideData, 1000);
    </script>
  </body>
</html>
